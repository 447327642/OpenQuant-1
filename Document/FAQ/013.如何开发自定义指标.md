# How to develop a custom indicator

OpenQuant offers a possibility to develop custom user indicators and use such user indicators in 
OpenQuant strategy.

You can develop a custom indicator as a dll in MS Visual Studio and add to OpenQuant as a reference. 
You can exchange your custom indicators with another OpenQuant users this way (without need to 
disclose indicator code if you don't want to). Alternatively, you can add indicator code right before 
strategy code in OpenQuant editor and use it in this strategy.  

In order to start writing a user indicator you should add 
<pre>
using OpenQuant.API.Plugins;
</pre>
Any user indicator should derive from the UserIndicator class defined in the OpenQuant.API.Plugins 
namespace. 

Developing a user indicator in the OpenQuant framework is quite simple. All you need to do is to 
override the Calculate(int index) method of the UserIndicator class using Input property of 
UserIndicator class. 

The Input property is a reference to indicator input time series. It has ISeries type, so that it can be 
BarSeries, TimeSeries or another Indicator (this way you can develop indicator of indicator). 

The Calculate(int index) method should return indicator value calculated for the index-th element in 
the Input series. It should return Double.NaN if there is no indicator value for the index-th element of 
the Input series (usually in case of indicators that require several past values of Input time series, for 
example simple moving average or momentum indicators). 

Let's develop a simple Accumulated Money Flow (AMF) indicator as an example. The simplest formula 
will be making an upday volume negative and a down day volume positive and then adding up all the 
buy/sell volume from date from which the data became available. 

We create a new class that we call AMF and derive this class from UserIndicator class. Then we add a 
constructor of AMF class that takes BarSeries as input. 
<pre>
public class AMF: UserIndicator  
{  
   public AMF(BarSeries input) : base(input)  
   {
      Name = "AMF";
   }
}
</pre>
Note that we use the Name property of te UserIndicator class to give a name to our indicator. This 
name will be displayed on the Bar chart and elsewhere. 
 
Now if we write
<pre>
AMF indicator = new AMF(Bars); 
</pre>
in our strategy, we will create an AMF indicator called "AMF" and Input property assigned to the Bars 
series of our strategy. 
 
Now we need to override the Calculate method of our AMF indicator. 
<pre>
public class AMF: UserIndicator
{
   double volume = 0;

   public AMF(BarSeries input) : base(input)
   {
      Name = "AMF";
   }

   public override double Calculate(int index)
   {
      if (index > 1)
      {
         if (Input[index, BarData.Close] > Input[index-1, BarData.Close])
            volume += Input[index, BarData.Volume];
         else
            volume -= Input[index, BarData.Volume];
         
         return volume;
      }
      else
         return Double.NaN;
   }
}
</pre>
Note that we can use two techniques to work with the Input property. We can either cast it to a 
specific series type and use this type in our calculations, for example 
<pre>
BarSeries bars = Input as BarSeries; 

double close = bars[index].Close; 
</pre>
or we can use common indexers of ISeries interface. 
<pre>
double close = Input[index, BarData.Close]; 
</pre>
We use the latter techniques in our Calculation method. 
 
The rest of Calculate code is quite simple. First we check that we have enough elements in the Input 
series to access previous element (bar) of the Input series. We return Double.NaN if there is no 
previous bar. If we do have a previous bar, we compare closing prices of the current (index) bar and 
previous (index - 1) bar and then adjust volume class variable accordingly.  
 
Now we can add our indicator to a strategy and draw it on the strategy bar chart. 
<pre>
using System;
using System.Drawing;

using OpenQuant.API;
using OpenQuant.API.Indicators;
using OpenQuant.API.Plugins;

public class AMF: UserIndicator
{
   double volume = 0;

   public AMF(BarSeries input) : base(input)
   {
      Name = "AMF";
   }

   public override double Calculate(int index)
   {
      if (index > 1)
      {
         if (Input[index, BarData.Close] > Input[index-1, BarData.Close])
            volume += Input[index, BarData.Volume];
         else
            volume -= Input[index, BarData.Volume];
         
         return volume;
      }
      else
         return Double.NaN;
   }
}

public class MyStrategy : Strategy
{
   public override void OnStrategyStart()
   {
      AMF AMF = new AMF(Bars);
      
      AMF.Color = Color.White;
      
      Draw(AMF, 2);
   }

   public override void OnBar(Bar bar)
   {
   }
}
</pre>
Note that there are several other examples of user indicators included in the OpenQuant installation. 
They can be found in the Samples folder in OpenQuant Windows menu. 